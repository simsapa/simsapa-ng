(()=>{"use strict";var e=function(){return e=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++)for(var s in t=arguments[n])Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s]);return e},e.apply(this,arguments)};function t(e){return Object.freeze(e.reduce(function(e,t){var n;return Object.assign(e,((n={})[t.toLocaleLowerCase()]=!0,n))},{}))}t(["base","head","link","meta","style","title"]);var n=t(["address","article","aside","footer","header","h1","h2","h3","h4","h5","h6","hgroup","main","nav","section"]),i=t(["blockquote","dd","dir","div","dl","dt","figcaption","figure","hr","li","main","ol","p","pre","ul"]),s=t(["a","abbr","b","bdi","bdo","br","cite","code","data","dfn","em","i","kbd","mark","q","rb","rt","rtc","ruby","s","samp","small","span","strong","sub","sup","time","tt","u","var","wbr"]),r=t(["area","audio","img","map","track","video"]),a=t(["applet","embed","iframe","noembed","object","param","picture","source"]),o=(t(["canvas","noscript","script"]),t(["del","ins"]),t(["caption","col","colgroup","table","tbody","td","tfoot","th","thead","tr"])),c=t(["button","datalist","fieldset","form","input","label","legend","meter","optgroup","option","output","progress","select","textarea"]),h=(t(["details","dialog","menu","menuitem","summary"]),t(["acronym","applet","basefont","bgsound","big","blink","center","command","content","dir","element","font","frame","frameset","image","isindex","keygen","listing","marquee","menuitem","multicol","nextid","nobr","noembed","noframes","plaintext","shadow","spacer","strike","tt","xmp"]),t(["br","img","col","hr"])),l=e(e(e(e(e(e(e({},n),i),r),a),o),c),h);function d(e){return!!e&&e.nodeType===Node.ELEMENT_NODE}function u(e){return!!e&&e.nodeType===Node.TEXT_NODE}function p(e){return d(e)&&!!l[e.tagName.toLocaleLowerCase()]}function f(e){return d(e)&&(function(e){return d(e)&&!!h[e.tagName.toLocaleLowerCase()]}(e)||-1!==["SVG"].indexOf(e.tagName.toUpperCase()))}e(e({},s),{br:void 0,code:void 0});var m=function(){function e(e,t){this.foundText=t||"",this.text=e,this.range={start:0,end:0},this.replaceFunction=function(e){return document.createTextNode(e)}}return e.prototype.replace=function(){var e=this.range,t=e.start,n=e.end;if(t===n)return null;var i=this.text.slice(t,n);return this.replaceFunction(i,this.foundText)},e}(),g=function(){function e(e){this.next=null,this.replacements=[],this.replacedNodes=[],this.textNode=e}return e.prototype.addReplacement=function(e){if(0===this.replacements.length){if(e.range.start>0){var t=new m(this.textNode.nodeValue);t.range={start:0,end:e.range.start},this.replacements.push(t)}}else{var n=this.replacements[this.replacements.length-1];if(e.range.start-n.range.end>0){var i=new m(this.textNode.nodeValue);i.range={start:n.range.end,end:e.range.start},this.replacements.push(i)}else if(e.range.start-n.range.end<0)throw"Can't add replacement if replacement.range.start is less than last added replacement.range.end"}this.replacements.push(e)},e.prototype.replace=function(){var e=this.replacements[this.replacements.length-1],t=[];if(e.range.end<this.textNode.nodeValue.length){var n=new m(this.textNode.nodeValue);n.range={start:e.range.end,end:this.textNode.nodeValue.length},t.push(n)}var i=this.replacements.concat(t).reduce(function(e,t){var n=t.replace();return n?(e.push(n),e):e},[]);this.replacedNodes=i,this.textNode.parentNode&&this.textNode.parentNode.replaceChild(i.reduce(function(e,t){return e.appendChild(t),e},document.createDocumentFragment()),this.textNode)},e.prototype.recover=function(){for(var e=!1,t=0;t<this.replacedNodes.length;t++){var n=this.replacedNodes[t];try{var i=n.parentNode;if(!i)continue;e?i.removeChild(n):(i.replaceChild(this.textNode,n),e=!0)}catch(e){console.error("You might have changed dom node so that we can't recover")}}},e}(),v=function(){function e(){this.head=null,this.tail=null}return e.prototype.add=function(e){this.head?this.head!==e&&this.tail&&(this.tail.next=e,this.tail=e):this.head=this.tail=e},e}(),b=function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var i,s,r=n.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(i=r.next()).done;)a.push(i.value)}catch(e){s={error:e}}finally{try{i&&!i.done&&(n=r.return)&&n.call(r)}finally{if(s)throw s.error}}return a};function x(e,t){var n=t.flag,i=t.find,s=t.replace,r=function(e){var t=[],n=[],i=[];if(!e.firstChild||!p(e))return i;t.push({node:e.firstChild,parentBlock:e});var s=e;for(i.push([]);t.length>0;){var r=t.pop(),a=r.node,o=r.parentBlock,c=a.firstChild,h=a.nextSibling,l=a.parentNode;s!==o&&0!==i[i.length-1].length&&i.push([]),s=o,u(a)?i[i.length-1].push(a):f(a)&&0!==i[i.length-1].length&&i.push([]),c?(t.push({node:c,parentBlock:p(a)?a:o}),h&&n.push({node:h,parentBlock:p(l)?l:o})):h?t.push({node:h,parentBlock:p(l)?l:o}):n.length>0&&t.push(n.pop())}return i}(e),a=r.map(function(e){var t=function(e){for(var t=[],n="",i=0;i<e.length;i++){var s=e[i];t.push({textNode:s,text:s.nodeValue,range:{start:n.length,end:n.length+s.nodeValue.length}}),n="".concat(n).concat(s.nodeValue)}return{text:n,ranges:t}}(e),r=t.text,a=t.ranges,o=new RegExp(i,n),c=new Map,h=new v,l=o.exec(r);if(!l)return null;for(;l&&l[0];){for(var d=l.index,u=b(l,1)[0],p=d+u.length,f="string"==typeof s?s:"",x="string"==typeof s?u:"",E="",y=0;y<a.length;y++){var C=a[y],k=C.textNode,w=C.text,B=C.range,N=B.start,I=B.end;if(!(N>p||I<d)){var S=new m(w,u);if(S.range={start:Math.max(N,d)-N,end:Math.min(I,p)-N},"string"==typeof s){var L=S.range;E=f.slice(0,L.end-L.start),f=f.slice(L.end-L.start),!(x=x.slice(L.end-L.start))&&f.length>0&&(E="".concat(E).concat(f),f=""),S.replaceFunction=function(e){return function(){return document.createTextNode(e)}}(E)}else S.replaceFunction=s;var M=c.get(k);M||(M=new g(k),h.add(M),c.set(k,M)),M.addReplacement(S)}}l=o.exec(r)}c.clear();for(var T=h.head;T;)T.replace(),T=T.next;return function(){for(var e=null==h?void 0:h.head;e;)e.recover(),e=e.next;h=null}});return function(){return a.forEach(function(e){null==e||e()})}}function E(){return window.SimsapaFindState||(window.SimsapaFindState=new Map),window.SimsapaFindState}const y=new class{constructor(){this.searchTerm="",this.currentMatchIndex=0,this.totalMatches=0,this.isVisible=!1,this.recoverFunction=null,this.debounceTimer=null,this.searchButton=null,this.findBar=null,this.findInput=null,this.findCounter=null,this.findError=null,this.prevButton=null,this.nextButton=null,this.accentFoldCheckbox=null,this.caseSensitiveCheckbox=null,this.contentArea=null,this.initializeElements()}initializeElements(){"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>this.bindElements()):this.bindElements()}bindElements(){this.searchButton=document.getElementById("findSearchButton"),this.findBar=document.getElementById("findBar"),this.findInput=document.getElementById("findInput"),this.findCounter=document.getElementById("findCounter"),this.findError=document.getElementById("findError"),this.prevButton=document.getElementById("findPrevButton"),this.nextButton=document.getElementById("findNextButton"),this.accentFoldCheckbox=document.getElementById("findAccentFold"),this.caseSensitiveCheckbox=document.getElementById("findCaseSensitive"),this.contentArea=document.getElementById("ssp_content"),this.setupEventListeners(),this.loadPreferences()}setupEventListeners(){this.searchButton&&this.searchButton.addEventListener("click",()=>this.toggle()),this.findInput&&(this.findInput.addEventListener("input",e=>{const t=e.target;this.debouncedSearch(t.value)}),this.findInput.addEventListener("keydown",e=>this.handleInputKeydown(e))),this.nextButton&&this.nextButton.addEventListener("click",()=>this.nextMatch()),this.prevButton&&this.prevButton.addEventListener("click",()=>this.previousMatch()),this.accentFoldCheckbox&&this.accentFoldCheckbox.addEventListener("change",()=>{this.searchTerm&&this.search(this.searchTerm),this.savePreferences()}),this.caseSensitiveCheckbox&&this.caseSensitiveCheckbox.addEventListener("change",()=>{this.searchTerm&&this.search(this.searchTerm),this.savePreferences()}),document.addEventListener("keydown",e=>this.handleGlobalKeydown(e))}handleInputKeydown(e){"Enter"===e.key?e.shiftKey?(e.preventDefault(),this.previousMatch()):(e.preventDefault(),this.nextMatch()):"Escape"===e.key&&(e.preventDefault(),this.hide())}handleGlobalKeydown(e){return e.ctrlKey&&"f"===e.key?(e.preventDefault(),void this.show()):"Escape"===e.key&&this.isVisible?(e.preventDefault(),void this.hide()):void 0}loadPreferences(){const e=E(),t=e.get("simsapa-find-term");t&&this.findInput&&(this.findInput.value=t);const n=e.get("simsapa-find-accent-fold");this.accentFoldCheckbox&&(this.accentFoldCheckbox.checked=!1!==n);const i=e.get("simsapa-find-case-sensitive");this.caseSensitiveCheckbox&&(this.caseSensitiveCheckbox.checked=!0===i)}savePreferences(){const e=E();this.findInput&&e.set("simsapa-find-term",this.findInput.value),this.accentFoldCheckbox&&e.set("simsapa-find-accent-fold",this.accentFoldCheckbox.checked),this.caseSensitiveCheckbox&&e.set("simsapa-find-case-sensitive",this.caseSensitiveCheckbox.checked)}debouncedSearch(e){null!==this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{this.search(e),this.savePreferences()},400)}show(){this.findBar&&this.searchButton&&(this.isVisible=!0,this.searchButton.classList.add("active"),this.findBar.classList.add("show"),setTimeout(()=>{this.findInput&&(this.findInput.focus(),this.findInput.select(),this.findInput.value&&this.findInput.value.length>=2&&this.search(this.findInput.value))},100))}hide(){this.findBar&&this.searchButton&&(this.isVisible=!1,this.searchButton.classList.remove("active"),this.findBar.classList.remove("show"),this.clearHighlights(),this.clearError())}clearHighlights(){this.recoverFunction&&(this.recoverFunction(),this.recoverFunction=null),this.updateCounter(0,0)}clearError(){this.findError&&(this.findError.classList.remove("show"),this.findError.textContent="")}updateCounter(e,t){this.findCounter&&(this.findCounter.textContent=`${e}/${t}`),this.currentMatchIndex=e,this.totalMatches=t}search(e){if(this.clearHighlights(),this.clearError(),e&&!(e.length<2)&&this.contentArea){this.searchTerm=e;try{this.recoverFunction=this.performSearch(e),this.updateMatchNavigation()}catch(e){this.showError("Invalid search pattern")}}}performSearch(e){if(!this.contentArea)return null;let t="g";this.isCaseSensitive()||(t+="i");const n=this.isAccentFoldingEnabled()?this.createAccentFoldedPattern(e):e,i=(r=this.contentArea,a={find:n,flag:t,replace:(e,t)=>{const n=document.createElement("span");return n.className="ssp-find-highlight",n.textContent=e,n}},o=Object.assign({},{flag:"g"},a),"string"==typeof r?function(e,t){var n=document.createElement("div");return n.innerHTML=e,x(n,t),n.innerHTML}(r,o):d(r)?x(r,o):null),s=this.contentArea.querySelectorAll(".ssp-find-highlight");var r,a,o;return this.updateCounter(s.length>0?1:0,s.length),0===s.length?(this.showError("No matches found"),i):(s.length>1e3&&this.showError(`Too many matches (${s.length}). Results limited to improve performance.`),s[0].classList.add("current"),this.scrollToElement(s[0]),i)}createAccentFoldedPattern(e){if(!this.isAccentFoldingEnabled())return e;const t=["ā","ī","ū","ṃ","ṁ","ṅ","ñ","ṭ","ḍ","ṇ","ḷ","ṛ","ṣ","ś"],n=["a","i","u","m","m","n","n","t","d","n","l","r","s","s"],i=new Map;for(let e=0;e<t.length;e++){const s=t[e],r=n[e],a=`[${r}${s}]`;i.set(r,a),i.set(s,a)}let s="";for(const t of e)s+=i.get(t)||t;return s}isAccentFoldingEnabled(){return!this.accentFoldCheckbox||this.accentFoldCheckbox.checked}isCaseSensitive(){return!!this.caseSensitiveCheckbox&&this.caseSensitiveCheckbox.checked}updateMatchNavigation(){if(!this.prevButton||!this.nextButton)return;const e=this.totalMatches>0;this.prevButton.style.opacity=e?"1":"0.5",this.nextButton.style.opacity=e?"1":"0.5"}scrollToElement(e){e.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})}showError(e){this.findError&&(this.findError.textContent=e,this.findError.classList.add("show"))}nextMatch(){if(!this.contentArea||0===this.totalMatches)return;const e=this.contentArea.querySelectorAll(".ssp-find-highlight");if(0===e.length)return;e.forEach(e=>e.classList.remove("current"));let t=this.currentMatchIndex%this.totalMatches;e[t].classList.add("current"),this.updateCounter(t+1,this.totalMatches),this.scrollToElement(e[t])}previousMatch(){if(!this.contentArea||0===this.totalMatches)return;const e=this.contentArea.querySelectorAll(".ssp-find-highlight");if(0===e.length)return;e.forEach(e=>e.classList.remove("current"));let t=this.currentMatchIndex-2;t<0&&(t=this.totalMatches-1),e[t].classList.add("current"),this.updateCounter(t+1,this.totalMatches),this.scrollToElement(e[t])}toggle(){this.isVisible?this.hide():this.show()}isShown(){return this.isVisible}};document.SSP={show_transient_message:function(e,t){const n=document.createElement("div");n.className="message";const i=document.createElement("div");i.className="msg-content",i.textContent=e,n.appendChild(i);let s=document.getElementById(t);s?(s.appendChild(n),n.style.transition="opacity 1.5s ease-in-out",n.style.opacity="1",setTimeout(()=>{n.style.opacity="0"},1e3),n.addEventListener("transitionend",()=>{n.remove()})):console.error("Cannot find: transient-messages")},find:y}})();