(()=>{"use strict";var t=function(t,e,n,i){return new(n||(n=Promise))(function(s,r){function o(t){try{c(i.next(t))}catch(t){r(t)}}function a(t){try{c(i.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(o,a)}c((i=i.apply(t,e||[])).next())})};const e=/\b(DN|MN|SN|AN|Pv|Vv|Vism|iti|kp|khp|snp|th|thag|thig|ud|uda|dhp)[ .]*(\d[\d.:]*)\b/i;function n(e,n){return t(this,void 0,void 0,function*(){const t=globalThis.API_URL||"http://localhost:4848",i=yield fetch(`${t}/logger`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({log_level:n,msg:e})});if(!i.ok)throw new Error(`HTTP error! status: ${i.status} ${i.statusText}`)})}function i(e){return t(this,void 0,void 0,function*(){console.log(e),n(e,"info")})}function s(e){return t(this,void 0,void 0,function*(){console.error(e),n(e,"error")})}function r(t){const n=t.getAttribute("href")||"",i=t.textContent||"";if(n.startsWith("ssp://")){const t=n.match(/^ssp:\/\/suttas\/(.+)$/);if(t)return t[1]}if(n.includes("suttacentral.net")){const t=n.match(/suttacentral\.net\/(.+)$/);if(t)return t[1]}if(n.includes("thebuddhaswords.net")){const t=n.match(/\/suttas\/([^.]+)\.html/);if(t)return`${t[1]}/pli/ms`}const s=i.replace(/:/g,".").match(e);return s?`${s[1].toLowerCase()}${s[2]}/pli/ms`:null}function o(e){return t(this,void 0,void 0,function*(){const n=e.target;let o=null;if(o="A"===n.tagName?n:n.closest("a"),!o)return;const a=o.getAttribute("href")||"";if(a.startsWith("#"))return;const c=r(o);if(c)return e.preventDefault(),void(yield function(e,n){return t(this,void 0,void 0,function*(){const r=window,o=r.API_URL||globalThis.API_URL||"http://localhost:4848",a=r.WINDOW_ID||globalThis.WINDOW_ID;if(!a||""===a)return yield s(`WINDOW_ID not defined, falling back to open_sutta_by_uid for uid='${e}'`),void(yield function(e,n){return t(this,void 0,void 0,function*(){const t=globalThis.API_URL||"http://localhost:4848";try{const r=`${t}/open_sutta_window/${e}`,o=yield fetch(r);if(404===o.status){s(`Sutta not found: ${e}`);let t=`Sutta not found in database: ${e}`;n?(t+=`\n\nOriginal URL: ${n}\n\nWould you like to open this link in your web browser?`,confirm(t)&&window.open(n,"_blank")):alert(t)}else o.ok?i(`Successfully opened sutta ${e}`):s(`Failed to open sutta ${e}: ${o.status}`)}catch(t){const n=t instanceof Error?t.message:String(t);s(`Error opening sutta ${e}: ${n}`)}})}(e,n));yield i(`open_sutta_in_tab: WINDOW_ID='${a}', uid='${e}'`);try{const t=`${o}/open_sutta_tab/${a}/${e}`,i=yield fetch(t);if(404===i.status){s(`Sutta not found: ${e}`);let t=`Sutta not found in database: ${e}`;n?(t+=`\n\nOriginal URL: ${n}\n\nWould you like to open this link in your web browser?`,confirm(t)&&window.open(n,"_blank")):alert(t)}else i.ok||s(`Failed to open sutta ${e}: ${i.status}`)}catch(t){const n=t instanceof Error?t.message:String(t);s(`Error opening sutta ${e}: ${n}`)}})}(c,a));if(a.startsWith("/book_pages/")){const n=window.location.pathname,r=a.split("#")[0];return r!==n.split("#")[0]&&""!==r?(e.preventDefault(),void(yield function(e){return t(this,void 0,void 0,function*(){const t=window,n=t.API_URL||globalThis.API_URL||"http://localhost:4848",r=t.WINDOW_ID||globalThis.WINDOW_ID;if(!r||""===r)return yield i(`WINDOW_ID not defined, navigating to book page: ${e}`),void(window.location.href=e);yield i(`open_book_page_in_tab: WINDOW_ID='${r}', url='${e}'`);try{const t=`${n}/open_book_page_tab/${r}`,i=yield fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({book_page_url:e})});i.ok||(yield s(`Failed to open book page ${e}: ${i.status}`))}catch(t){const n=t instanceof Error?t.message:String(t);yield s(`Error opening book page ${e}: ${n}`)}})}(a))):void 0}return a.startsWith("http://")||a.startsWith("https://")?(e.preventDefault(),void(confirm(`Open this link in your web browser?\n\n${a}`)&&window.open(a,"_blank"))):void 0})}var a=function(){return a=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var s in e=arguments[n])Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t},a.apply(this,arguments)};function c(t){return Object.freeze(t.reduce(function(t,e){var n;return Object.assign(t,((n={})[e.toLocaleLowerCase()]=!0,n))},{}))}c(["base","head","link","meta","style","title"]);var h=c(["address","article","aside","footer","header","h1","h2","h3","h4","h5","h6","hgroup","main","nav","section"]),l=c(["blockquote","dd","dir","div","dl","dt","figcaption","figure","hr","li","main","ol","p","pre","ul"]),d=c(["a","abbr","b","bdi","bdo","br","cite","code","data","dfn","em","i","kbd","mark","q","rb","rt","rtc","ruby","s","samp","small","span","strong","sub","sup","time","tt","u","var","wbr"]),u=c(["area","audio","img","map","track","video"]),f=c(["applet","embed","iframe","noembed","object","param","picture","source"]),p=(c(["canvas","noscript","script"]),c(["del","ins"]),c(["caption","col","colgroup","table","tbody","td","tfoot","th","thead","tr"])),m=c(["button","datalist","fieldset","form","input","label","legend","meter","optgroup","option","output","progress","select","textarea"]),g=(c(["details","dialog","menu","menuitem","summary"]),c(["acronym","applet","basefont","bgsound","big","blink","center","command","content","dir","element","font","frame","frameset","image","isindex","keygen","listing","marquee","menuitem","multicol","nextid","nobr","noembed","noframes","plaintext","shadow","spacer","strike","tt","xmp"]),c(["br","img","col","hr"])),v=a(a(a(a(a(a(a({},h),l),u),f),p),m),g);function b(t){return!!t&&t.nodeType===Node.ELEMENT_NODE}function y(t){return!!t&&t.nodeType===Node.TEXT_NODE}function x(t){return b(t)&&!!v[t.tagName.toLocaleLowerCase()]}function E(t){return b(t)&&(function(t){return b(t)&&!!g[t.tagName.toLocaleLowerCase()]}(t)||-1!==["SVG"].indexOf(t.tagName.toUpperCase()))}a(a({},d),{br:void 0,code:void 0});var w=function(){function t(t,e){this.foundText=e||"",this.text=t,this.range={start:0,end:0},this.replaceFunction=function(t){return document.createTextNode(t)}}return t.prototype.replace=function(){var t=this.range,e=t.start,n=t.end;if(e===n)return null;var i=this.text.slice(e,n);return this.replaceFunction(i,this.foundText)},t}(),k=function(){function t(t){this.next=null,this.replacements=[],this.replacedNodes=[],this.textNode=t}return t.prototype.addReplacement=function(t){if(0===this.replacements.length){if(t.range.start>0){var e=new w(this.textNode.nodeValue);e.range={start:0,end:t.range.start},this.replacements.push(e)}}else{var n=this.replacements[this.replacements.length-1];if(t.range.start-n.range.end>0){var i=new w(this.textNode.nodeValue);i.range={start:n.range.end,end:t.range.start},this.replacements.push(i)}else if(t.range.start-n.range.end<0)throw"Can't add replacement if replacement.range.start is less than last added replacement.range.end"}this.replacements.push(t)},t.prototype.replace=function(){var t=this.replacements[this.replacements.length-1],e=[];if(t.range.end<this.textNode.nodeValue.length){var n=new w(this.textNode.nodeValue);n.range={start:t.range.end,end:this.textNode.nodeValue.length},e.push(n)}var i=this.replacements.concat(e).reduce(function(t,e){var n=e.replace();return n?(t.push(n),t):t},[]);this.replacedNodes=i,this.textNode.parentNode&&this.textNode.parentNode.replaceChild(i.reduce(function(t,e){return t.appendChild(e),t},document.createDocumentFragment()),this.textNode)},t.prototype.recover=function(){for(var t=!1,e=0;e<this.replacedNodes.length;e++){var n=this.replacedNodes[e];try{var i=n.parentNode;if(!i)continue;t?i.removeChild(n):(i.replaceChild(this.textNode,n),t=!0)}catch(t){console.error("You might have changed dom node so that we can't recover")}}},t}(),C=function(){function t(){this.head=null,this.tail=null}return t.prototype.add=function(t){this.head?this.head!==t&&this.tail&&(this.tail.next=t,this.tail=t):this.head=this.tail=t},t}(),I=function(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var i,s,r=n.call(t),o=[];try{for(;(void 0===e||e-- >0)&&!(i=r.next()).done;)o.push(i.value)}catch(t){s={error:t}}finally{try{i&&!i.done&&(n=r.return)&&n.call(r)}finally{if(s)throw s.error}}return o};function N(t,e){var n=e.flag,i=e.find,s=e.replace,r=function(t){var e=[],n=[],i=[];if(!t.firstChild||!x(t))return i;e.push({node:t.firstChild,parentBlock:t});var s=t;for(i.push([]);e.length>0;){var r=e.pop(),o=r.node,a=r.parentBlock,c=o.firstChild,h=o.nextSibling,l=o.parentNode;s!==a&&0!==i[i.length-1].length&&i.push([]),s=a,y(o)?i[i.length-1].push(o):E(o)&&0!==i[i.length-1].length&&i.push([]),c?(e.push({node:c,parentBlock:x(o)?o:a}),h&&n.push({node:h,parentBlock:x(l)?l:a})):h?e.push({node:h,parentBlock:x(l)?l:a}):n.length>0&&e.push(n.pop())}return i}(t),o=r.map(function(t){var e=function(t){for(var e=[],n="",i=0;i<t.length;i++){var s=t[i];e.push({textNode:s,text:s.nodeValue,range:{start:n.length,end:n.length+s.nodeValue.length}}),n="".concat(n).concat(s.nodeValue)}return{text:n,ranges:e}}(t),r=e.text,o=e.ranges,a=new RegExp(i,n),c=new Map,h=new C,l=a.exec(r);if(!l)return null;for(;l&&l[0];){for(var d=l.index,u=I(l,1)[0],f=d+u.length,p="string"==typeof s?s:"",m="string"==typeof s?u:"",g="",v=0;v<o.length;v++){var b=o[v],y=b.textNode,x=b.text,E=b.range,N=E.start,S=E.end;if(!(N>f||S<d)){var L=new w(x,u);if(L.range={start:Math.max(N,d)-N,end:Math.min(S,f)-N},"string"==typeof s){var B=L.range;g=p.slice(0,B.end-B.start),p=p.slice(B.end-B.start),!(m=m.slice(B.end-B.start))&&p.length>0&&(g="".concat(g).concat(p),p=""),L.replaceFunction=function(t){return function(){return document.createTextNode(t)}}(g)}else L.replaceFunction=s;var _=c.get(y);_||(_=new k(y),h.add(_),c.set(y,_)),_.addReplacement(L)}}l=a.exec(r)}c.clear();for(var $=h.head;$;)$.replace(),$=$.next;return function(){for(var t=null==h?void 0:h.head;t;)t.recover(),t=t.next;h=null}});return function(){return o.forEach(function(t){null==t||t()})}}function S(){return window.SimsapaFindState||(window.SimsapaFindState=new Map),window.SimsapaFindState}const L=new class{constructor(){this.searchTerm="",this.currentMatchIndex=0,this.totalMatches=0,this.isVisible=!1,this.recoverFunction=null,this.debounceTimer=null,this.searchButton=null,this.findBar=null,this.findInput=null,this.findCounter=null,this.findError=null,this.prevButton=null,this.nextButton=null,this.accentFoldCheckbox=null,this.caseSensitiveCheckbox=null,this.contentArea=null,this.initializeElements()}initializeElements(){"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>this.bindElements()):this.bindElements()}bindElements(){this.searchButton=document.getElementById("findSearchButton"),this.findBar=document.getElementById("findBar"),this.findInput=document.getElementById("findInput"),this.findCounter=document.getElementById("findCounter"),this.findError=document.getElementById("findError"),this.prevButton=document.getElementById("findPrevButton"),this.nextButton=document.getElementById("findNextButton"),this.accentFoldCheckbox=document.getElementById("findAccentFold"),this.caseSensitiveCheckbox=document.getElementById("findCaseSensitive"),this.contentArea=document.getElementById("ssp_content"),this.setupEventListeners(),this.loadPreferences()}setupEventListeners(){this.searchButton&&this.searchButton.addEventListener("click",()=>this.toggle()),this.findInput&&(this.findInput.addEventListener("input",t=>{const e=t.target;this.debouncedSearch(e.value)}),this.findInput.addEventListener("keydown",t=>this.handleInputKeydown(t))),this.nextButton&&this.nextButton.addEventListener("click",()=>this.nextMatch()),this.prevButton&&this.prevButton.addEventListener("click",()=>this.previousMatch()),this.accentFoldCheckbox&&this.accentFoldCheckbox.addEventListener("change",()=>{this.searchTerm&&this.search(this.searchTerm),this.savePreferences()}),this.caseSensitiveCheckbox&&this.caseSensitiveCheckbox.addEventListener("change",()=>{this.searchTerm&&this.search(this.searchTerm),this.savePreferences()}),document.addEventListener("keydown",t=>this.handleGlobalKeydown(t))}handleInputKeydown(t){"Enter"===t.key?t.shiftKey?(t.preventDefault(),this.previousMatch()):(t.preventDefault(),this.nextMatch()):"Escape"===t.key&&(t.preventDefault(),this.hide())}handleGlobalKeydown(t){return t.ctrlKey&&"f"===t.key?(t.preventDefault(),void this.show()):"Escape"===t.key&&this.isVisible?(t.preventDefault(),void this.hide()):void 0}loadPreferences(){const t=S(),e=t.get("simsapa-find-term");e&&this.findInput&&(this.findInput.value=e);const n=t.get("simsapa-find-accent-fold");this.accentFoldCheckbox&&(this.accentFoldCheckbox.checked=!1!==n);const i=t.get("simsapa-find-case-sensitive");this.caseSensitiveCheckbox&&(this.caseSensitiveCheckbox.checked=!0===i)}savePreferences(){const t=S();this.findInput&&t.set("simsapa-find-term",this.findInput.value),this.accentFoldCheckbox&&t.set("simsapa-find-accent-fold",this.accentFoldCheckbox.checked),this.caseSensitiveCheckbox&&t.set("simsapa-find-case-sensitive",this.caseSensitiveCheckbox.checked)}debouncedSearch(t){null!==this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{this.search(t),this.savePreferences()},400)}show(){this.findBar&&this.searchButton&&(this.isVisible=!0,this.searchButton.classList.add("active"),this.findBar.classList.add("show"),setTimeout(()=>{this.findInput&&(this.findInput.focus(),this.findInput.select(),this.findInput.value&&this.findInput.value.length>=2&&this.search(this.findInput.value))},100))}hide(){this.findBar&&this.searchButton&&(this.isVisible=!1,this.searchButton.classList.remove("active"),this.findBar.classList.remove("show"),this.clearHighlights(),this.clearError())}clearHighlights(){this.recoverFunction&&(this.recoverFunction(),this.recoverFunction=null),this.updateCounter(0,0)}clearError(){this.findError&&(this.findError.classList.remove("show"),this.findError.textContent="")}updateCounter(t,e){this.findCounter&&(this.findCounter.textContent=`${t}/${e}`),this.currentMatchIndex=t,this.totalMatches=e}search(t){if(this.clearHighlights(),this.clearError(),t&&!(t.length<2)&&this.contentArea){this.searchTerm=t;try{this.recoverFunction=this.performSearch(t),this.updateMatchNavigation()}catch(t){this.showError("Invalid search pattern")}}}performSearch(t){if(!this.contentArea)return null;let e="g";this.isCaseSensitive()||(e+="i");const n=this.isAccentFoldingEnabled()?this.createAccentFoldedPattern(t):t,i=(r=this.contentArea,o={find:n,flag:e,replace:(t,e)=>{const n=document.createElement("span");return n.className="ssp-find-highlight",n.textContent=t,n}},a=Object.assign({},{flag:"g"},o),"string"==typeof r?function(t,e){var n=document.createElement("div");return n.innerHTML=t,N(n,e),n.innerHTML}(r,a):b(r)?N(r,a):null),s=this.contentArea.querySelectorAll(".ssp-find-highlight");var r,o,a;return this.updateCounter(s.length>0?1:0,s.length),0===s.length?(this.showError("No matches found"),i):(s.length>1e3&&this.showError(`Too many matches (${s.length}). Results limited to improve performance.`),s[0].classList.add("current"),this.scrollToElement(s[0]),i)}createAccentFoldedPattern(t){if(!this.isAccentFoldingEnabled())return t;const e=["ā","ī","ū","ṃ","ṁ","ṅ","ñ","ṭ","ḍ","ṇ","ḷ","ṛ","ṣ","ś"],n=["a","i","u","m","m","n","n","t","d","n","l","r","s","s"],i=new Map;for(let t=0;t<e.length;t++){const s=n[t],r=e[t];i.has(s)||i.set(s,new Set([s])),i.get(s).add(r)}const s=new Map;for(const[t,e]of i){const n=`[${Array.from(e).join("")}]`;s.set(t,n);for(const i of e)i!==t&&s.set(i,n)}let r="";for(const e of t)r+=s.get(e)||e;return r}isAccentFoldingEnabled(){return!this.accentFoldCheckbox||this.accentFoldCheckbox.checked}isCaseSensitive(){return!!this.caseSensitiveCheckbox&&this.caseSensitiveCheckbox.checked}updateMatchNavigation(){if(!this.prevButton||!this.nextButton)return;const t=this.totalMatches>0;this.prevButton.style.opacity=t?"1":"0.5",this.nextButton.style.opacity=t?"1":"0.5"}scrollToElement(t){t.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})}showError(t){this.findError&&(this.findError.textContent=t,this.findError.classList.add("show"))}nextMatch(){if(!this.contentArea||0===this.totalMatches)return;const t=this.contentArea.querySelectorAll(".ssp-find-highlight");if(0===t.length)return;t.forEach(t=>t.classList.remove("current"));let e=this.currentMatchIndex%this.totalMatches;t[e].classList.add("current"),this.updateCounter(e+1,this.totalMatches),this.scrollToElement(t[e])}previousMatch(){if(!this.contentArea||0===this.totalMatches)return;const t=this.contentArea.querySelectorAll(".ssp-find-highlight");if(0===t.length)return;t.forEach(t=>t.classList.remove("current"));let e=this.currentMatchIndex-2;e<0&&(e=this.totalMatches-1),t[e].classList.add("current"),this.updateCounter(e+1,this.totalMatches),this.scrollToElement(t[e])}toggle(){this.isVisible?this.hide():this.show()}isShown(){return this.isVisible}setSearchTerm(t){this.findInput&&(this.findInput.value=t,this.show(),t&&t.length>=2&&(this.search(t),this.savePreferences()))}};function B(){i("[simsapa] Attaching link handlers");const t=document.getElementById("ssp_content");t?t.querySelectorAll("a").forEach(t=>{r(t)&&t.classList.add("sutta-link"),t.addEventListener("click",o)}):document.querySelectorAll("a").forEach(t=>{r(t)&&t.classList.add("sutta-link"),t.addEventListener("click",o)})}document.SSP={show_transient_message:function(t,e){const n=document.createElement("div");n.className="message";const i=document.createElement("div");i.className="msg-content",i.textContent=t,n.appendChild(i);let s=document.getElementById(e);s?(s.appendChild(n),n.style.transition="opacity 1.5s ease-in-out",n.style.opacity="1",setTimeout(()=>{n.style.opacity="0"},1e3),n.addEventListener("transitionend",()=>{n.remove()})):console.error("Cannot find: transient-messages")},find:L,attach_link_handlers:B},document.addEventListener("DOMContentLoaded",()=>{i("[simsapa] DOMContentLoaded event fired"),B()})})();