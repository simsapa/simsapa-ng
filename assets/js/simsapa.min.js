(()=>{"use strict";var t={d:(e,n)=>{for(var i in n)t.o(n,i)&&!t.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:n[i]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};t.d({},{_:()=>A});var e=function(t,e,n,i){return new(n||(n=Promise))(function(o,s){function r(t){try{l(i.next(t))}catch(t){s(t)}}function a(t){try{l(i.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(r,a)}l((i=i.apply(t,e||[])).next())})};const n=new class{constructor(){this.overlay=null,this.message_element=null,this.confirm_button=null,this.cancel_button=null,this.copy_button=null,this.current_url="",this.resolve_callback=null,this.initialized=!1,this.handlers_bound=!1}init(){const t=document.getElementById("confirmModalOverlay"),e=document.getElementById("confirmModalMessage"),n=document.getElementById("confirmModalConfirm"),i=document.getElementById("confirmModalCancel"),o=document.getElementById("confirmModalCopy");if(!(t&&e&&n&&i&&o))return console.error("[ConfirmModal] Required elements not found in DOM"),void(this.initialized=!1);this.overlay===t&&this.confirm_button===n&&this.cancel_button===i&&this.copy_button===o&&this.initialized||(this.overlay=t,this.message_element=e,this.confirm_button=n,this.cancel_button=i,this.copy_button=o,this.confirm_button.addEventListener("click",()=>this.handle_confirm()),this.cancel_button.addEventListener("click",()=>this.handle_cancel()),this.copy_button.addEventListener("click",()=>this.handle_copy()),this.overlay.addEventListener("click",t=>this.handle_overlay_click(t)),this.handlers_bound||(document.addEventListener("keydown",t=>this.handle_keydown(t)),this.handlers_bound=!0),this.initialized=!0)}show(t,e){return this.init(),this.overlay&&this.message_element?(this.current_url=e,this.message_element.textContent=t,this.overlay.classList.add("show"),new Promise(t=>{this.resolve_callback=e=>{t(e.confirmed)}})):(console.error("[ConfirmModal] Modal not initialized"),Promise.resolve(!1))}handle_confirm(){this.close(!0)}handle_cancel(){this.close(!1)}handle_copy(){return e(this,void 0,void 0,function*(){if(this.current_url)try{const t=globalThis.API_URL||"http://localhost:4848",e=yield fetch(`${t}/copy_to_clipboard`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:this.current_url})});e.ok?this.show_copy_feedback(!0):(console.error("[ConfirmModal] Copy failed with status:",e.status),this.show_copy_feedback(!1))}catch(t){console.error("[ConfirmModal] Failed to copy URL:",t),this.show_copy_feedback(!1)}else console.error("[ConfirmModal] No URL to copy")})}show_copy_feedback(t){if(!this.copy_button)return;const e=this.copy_button.textContent;this.copy_button.textContent=t?"Copied!":"Copy Failed",this.copy_button.classList.add(t?"success":"error"),setTimeout(()=>{this.copy_button&&(this.copy_button.textContent=e,this.copy_button.classList.remove("success","error"))},2e3)}handle_overlay_click(t){t.target===this.overlay&&this.close(!1)}handle_keydown(t){var e;"Escape"===t.key&&(null===(e=this.overlay)||void 0===e?void 0:e.classList.contains("show"))&&this.close(!1)}close(t){this.overlay&&(this.overlay.classList.remove("show"),this.resolve_callback&&(this.resolve_callback({confirmed:t}),this.resolve_callback=null))}};function i(t){return e(this,void 0,void 0,function*(){const e=`Open this link in your web browser?\n\n${t}`;return n.show(e,t)})}const o=new class{constructor(){this.overlay=null,this.title_element=null,this.body_element=null,this.close_button=null,this.initialized=!1,this.handlers_bound=!1}init(){const t=document.getElementById("footnoteModalOverlay"),e=document.getElementById("footnoteModalTitle"),n=document.getElementById("footnoteModalBody"),i=document.getElementById("footnoteModalClose");if(!(t&&e&&n&&i))return console.error("[FootnoteModal] Required elements not found in DOM"),void(this.initialized=!1);this.overlay===t&&this.close_button===i&&this.initialized||(this.overlay=t,this.title_element=e,this.body_element=n,this.close_button=i,this.close_button.addEventListener("click",()=>this.close()),this.overlay.addEventListener("click",t=>this.handle_overlay_click(t)),this.handlers_bound||(document.addEventListener("keydown",t=>this.handle_keydown(t)),this.handlers_bound=!0),this.initialized=!0)}show(t,e){this.init(),this.overlay&&this.title_element&&this.body_element?(this.title_element.textContent=`Note ${t}`,this.body_element.innerHTML=e,A(this.body_element),this.overlay.classList.add("show")):console.error("[FootnoteModal] Modal not initialized")}handle_overlay_click(t){t.target===this.overlay&&this.close()}handle_keydown(t){var e;"Escape"===t.key&&(null===(e=this.overlay)||void 0===e?void 0:e.classList.contains("show"))&&this.close()}close(){this.overlay&&this.overlay.classList.remove("show")}is_visible(){var t;return(null===(t=this.overlay)||void 0===t?void 0:t.classList.contains("show"))||!1}};const s=new class{constructor(){this.overlay=null,this.title_element=null,this.body_element=null,this.close_button=null,this.initialized=!1,this.handlers_bound=!1}init(){const t=document.getElementById("invalidLinkModalOverlay"),e=document.getElementById("invalidLinkModalTitle"),n=document.getElementById("invalidLinkModalBody"),i=document.getElementById("invalidLinkModalClose");if(!(t&&e&&n&&i))return console.error("[InvalidLinkModal] Required elements not found in DOM"),void(this.initialized=!1);this.overlay===t&&this.close_button===i&&this.initialized||(this.overlay=t,this.title_element=e,this.body_element=n,this.close_button=i,this.close_button.addEventListener("click",()=>this.close()),this.overlay.addEventListener("click",t=>this.handle_overlay_click(t)),this.handlers_bound||(document.addEventListener("keydown",t=>this.handle_keydown(t)),this.handlers_bound=!0),this.initialized=!0)}show(t){this.init(),this.overlay&&this.title_element&&this.body_element?(this.title_element.textContent="Invalid Link",this.body_element.innerHTML=`Invalid link target: <code>${t}</code>`,A(this.body_element),this.overlay.classList.add("show")):console.error("[InvalidLinkModal] Modal not initialized")}handle_overlay_click(t){t.target===this.overlay&&this.close()}handle_keydown(t){var e;"Escape"===t.key&&(null===(e=this.overlay)||void 0===e?void 0:e.classList.contains("show"))&&this.close()}close(){this.overlay&&this.overlay.classList.remove("show")}is_visible(){var t;return(null===(t=this.overlay)||void 0===t?void 0:t.classList.contains("show"))||!1}};var r=function(t,e,n,i){return new(n||(n=Promise))(function(o,s){function r(t){try{l(i.next(t))}catch(t){s(t)}}function a(t){try{l(i.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(r,a)}l((i=i.apply(t,e||[])).next())})};const a=/\b(DN|MN|SN|AN|Pv|Vv|Vism|iti|kp|khp|snp|th|thag|thig|ud|uda|dhp)[ .]*(\d[\d.:]*)\b/i;function l(t,e){return r(this,void 0,void 0,function*(){const n=globalThis.API_URL||"http://localhost:4848",i=yield fetch(`${n}/logger`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({log_level:e,msg:t})});if(!i.ok)throw new Error(`HTTP error! status: ${i.status} ${i.statusText}`)})}function c(t){return r(this,void 0,void 0,function*(){console.log(t),l(t,"info")})}function h(t){return r(this,void 0,void 0,function*(){console.error(t),l(t,"error")})}function d(t){return r(this,void 0,void 0,function*(){const e=globalThis.API_URL||"http://localhost:4848";try{const n=yield fetch(`${e}/open_external_url`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:t})});n.ok||h(`Failed to open external URL: ${n.status}`)}catch(t){h(`Error opening external URL: ${t instanceof Error?t.message:String(t)}`)}})}function u(t){const e=t.getAttribute("href")||"",n=t.textContent||"";if(e.startsWith("ssp://")){const t=e.match(/^ssp:\/\/suttas\/(.+)$/);if(t)return t[1]}if(e.includes("suttacentral.net")){const t=e.match(/suttacentral\.net\/(.+)$/);if(t)return t[1]}if(e.includes("thebuddhaswords.net")){const t=e.match(/\/suttas\/([^.]+)\.html/);if(t)return`${t[1]}/pli/ms`}const i=n.replace(/:/g,".").match(a);return i?`${i[1].toLowerCase()}${i[2]}/pli/ms`:null}function f(t){return r(this,void 0,void 0,function*(){const e=t.target;let n=null;if(n="A"===e.tagName?e:e.closest("a"),!n)return;const a=n.getAttribute("href")||"";if(a.startsWith("#"))return function(t){const e=function(t){const e=t.getAttribute("href")||"";if(!e.startsWith("#"))return null;if(!t.closest(".footnote-reference, .fn"))return null;const n=e.substring(1);return document.getElementById(n)?n:null}(t);if(!e)return!1;const n=function(t){const e=document.getElementById(t);if(!e)return null;const n=e.cloneNode(!0);if(n.querySelectorAll('a[href^="#fr-"]').forEach(t=>t.remove()),"LI"===n.tagName)return n.innerHTML;if(n.classList.contains("footnote-definition")){const t=n.querySelector(".footnote-definition-label");return t&&t.remove(),n.innerHTML}if("P"===n.tagName){let t=n.innerHTML;return t=t.replace(/^\d+\.\s*/,""),t}return n.innerHTML}(e);if(!n)return console.error("[FootnoteModal] Could not find footnote content for:",e),!1;const i=(t.textContent||"").replace(/[\[\]]/g,"").trim();return o.show(i,n),!0}(n)?void t.preventDefault():void 0;const l=u(n);if(l)return t.preventDefault(),void(yield function(t,e){return r(this,void 0,void 0,function*(){const n=window,s=n.API_URL||globalThis.API_URL||"http://localhost:4848",a=n.WINDOW_ID||globalThis.WINDOW_ID;if(!a||""===a)return yield h(`WINDOW_ID not defined, falling back to open_sutta_by_uid for uid='${t}'`),void(yield function(t,e){return r(this,void 0,void 0,function*(){const n=globalThis.API_URL||"http://localhost:4848";try{const s=`${n}/open_sutta_window/${t}`,r=yield fetch(s);if(404===r.status){h(`Sutta not found: ${t}`);let n=`Sutta not found in database: ${t}`;e?(n+=`\n\nOriginal URL: ${e}\n\nWould you like to open this link in your web browser?`,o.is_visible()&&o.close(),(yield i(e))&&window.open(e,"_blank")):alert(n)}else r.ok?c(`Successfully opened sutta ${t}`):h(`Failed to open sutta ${t}: ${r.status}`)}catch(e){const n=e instanceof Error?e.message:String(e);h(`Error opening sutta ${t}: ${n}`)}})}(t,e));yield c(`open_sutta_in_tab: WINDOW_ID='${a}', uid='${t}'`);try{const n=`${s}/open_sutta_tab/${a}/${t}`,r=yield fetch(n);if(404===r.status){h(`Sutta not found: ${t}`);let n=`Sutta not found in database: ${t}`;e?(n+=`\n\nOriginal URL: ${e}\n\nWould you like to open this link in your web browser?`,o.is_visible()&&o.close(),(yield i(e))&&(yield d(e))):alert(n)}else r.ok||h(`Failed to open sutta ${t}: ${r.status}`)}catch(e){const n=e instanceof Error?e.message:String(e);h(`Error opening sutta ${t}: ${n}`)}})}(l,a));if(a.startsWith("/book_pages/")){const e=window.location.pathname,n=a.split("#")[0];return n!==e.split("#")[0]&&""!==n?(t.preventDefault(),void(yield function(t){return r(this,void 0,void 0,function*(){const e=window,n=e.API_URL||globalThis.API_URL||"http://localhost:4848",i=e.WINDOW_ID||globalThis.WINDOW_ID;if(!i||""===i)return yield c(`WINDOW_ID not defined, navigating to book page: ${t}`),void(window.location.href=t);yield c(`open_book_page_in_tab: WINDOW_ID='${i}', url='${t}'`);try{const e=`${n}/open_book_page_tab/${i}`,o=yield fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({book_page_url:t})});o.ok||(yield h(`Failed to open book page ${t}: ${o.status}`))}catch(e){const n=e instanceof Error?e.message:String(e);yield h(`Error opening book page ${t}: ${n}`)}})}(a))):void 0}return a.startsWith("http://")||a.startsWith("https://")?(t.preventDefault(),o.is_visible()&&o.close(),void((yield i(a))&&(yield d(a)))):a.startsWith("/")?(t.preventDefault(),o.is_visible()&&o.close(),void s.show(a)):void 0})}var p=function(){return p=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t},p.apply(this,arguments)};function m(t){return Object.freeze(t.reduce(function(t,e){var n;return Object.assign(t,((n={})[e.toLocaleLowerCase()]=!0,n))},{}))}m(["base","head","link","meta","style","title"]);var v=m(["address","article","aside","footer","header","h1","h2","h3","h4","h5","h6","hgroup","main","nav","section"]),y=m(["blockquote","dd","dir","div","dl","dt","figcaption","figure","hr","li","main","ol","p","pre","ul"]),g=m(["a","abbr","b","bdi","bdo","br","cite","code","data","dfn","em","i","kbd","mark","q","rb","rt","rtc","ruby","s","samp","small","span","strong","sub","sup","time","tt","u","var","wbr"]),b=m(["area","audio","img","map","track","video"]),_=m(["applet","embed","iframe","noembed","object","param","picture","source"]),k=(m(["canvas","noscript","script"]),m(["del","ins"]),m(["caption","col","colgroup","table","tbody","td","tfoot","th","thead","tr"])),w=m(["button","datalist","fieldset","form","input","label","legend","meter","optgroup","option","output","progress","select","textarea"]),E=(m(["details","dialog","menu","menuitem","summary"]),m(["acronym","applet","basefont","bgsound","big","blink","center","command","content","dir","element","font","frame","frameset","image","isindex","keygen","listing","marquee","menuitem","multicol","nextid","nobr","noembed","noframes","plaintext","shadow","spacer","strike","tt","xmp"]),m(["br","img","col","hr"])),x=p(p(p(p(p(p(p({},v),y),b),_),k),w),E);function L(t){return!!t&&t.nodeType===Node.ELEMENT_NODE}function C(t){return!!t&&t.nodeType===Node.TEXT_NODE}function I(t){return L(t)&&!!x[t.tagName.toLocaleLowerCase()]}function M(t){return L(t)&&(function(t){return L(t)&&!!E[t.tagName.toLocaleLowerCase()]}(t)||-1!==["SVG"].indexOf(t.tagName.toUpperCase()))}p(p({},g),{br:void 0,code:void 0});var B=function(){function t(t,e){this.foundText=e||"",this.text=t,this.range={start:0,end:0},this.replaceFunction=function(t){return document.createTextNode(t)}}return t.prototype.replace=function(){var t=this.range,e=t.start,n=t.end;if(e===n)return null;var i=this.text.slice(e,n);return this.replaceFunction(i,this.foundText)},t}(),N=function(){function t(t){this.next=null,this.replacements=[],this.replacedNodes=[],this.textNode=t}return t.prototype.addReplacement=function(t){if(0===this.replacements.length){if(t.range.start>0){var e=new B(this.textNode.nodeValue);e.range={start:0,end:t.range.start},this.replacements.push(e)}}else{var n=this.replacements[this.replacements.length-1];if(t.range.start-n.range.end>0){var i=new B(this.textNode.nodeValue);i.range={start:n.range.end,end:t.range.start},this.replacements.push(i)}else if(t.range.start-n.range.end<0)throw"Can't add replacement if replacement.range.start is less than last added replacement.range.end"}this.replacements.push(t)},t.prototype.replace=function(){var t=this.replacements[this.replacements.length-1],e=[];if(t.range.end<this.textNode.nodeValue.length){var n=new B(this.textNode.nodeValue);n.range={start:t.range.end,end:this.textNode.nodeValue.length},e.push(n)}var i=this.replacements.concat(e).reduce(function(t,e){var n=e.replace();return n?(t.push(n),t):t},[]);this.replacedNodes=i,this.textNode.parentNode&&this.textNode.parentNode.replaceChild(i.reduce(function(t,e){return t.appendChild(e),t},document.createDocumentFragment()),this.textNode)},t.prototype.recover=function(){for(var t=!1,e=0;e<this.replacedNodes.length;e++){var n=this.replacedNodes[e];try{var i=n.parentNode;if(!i)continue;t?i.removeChild(n):(i.replaceChild(this.textNode,n),t=!0)}catch(t){console.error("You might have changed dom node so that we can't recover")}}},t}(),T=function(){function t(){this.head=null,this.tail=null}return t.prototype.add=function(t){this.head?this.head!==t&&this.tail&&(this.tail.next=t,this.tail=t):this.head=this.tail=t},t}(),S=function(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var i,o,s=n.call(t),r=[];try{for(;(void 0===e||e-- >0)&&!(i=s.next()).done;)r.push(i.value)}catch(t){o={error:t}}finally{try{i&&!i.done&&(n=s.return)&&n.call(s)}finally{if(o)throw o.error}}return r};function $(t,e){var n=e.flag,i=e.find,o=e.replace,s=function(t){var e=[],n=[],i=[];if(!t.firstChild||!I(t))return i;e.push({node:t.firstChild,parentBlock:t});var o=t;for(i.push([]);e.length>0;){var s=e.pop(),r=s.node,a=s.parentBlock,l=r.firstChild,c=r.nextSibling,h=r.parentNode;o!==a&&0!==i[i.length-1].length&&i.push([]),o=a,C(r)?i[i.length-1].push(r):M(r)&&0!==i[i.length-1].length&&i.push([]),l?(e.push({node:l,parentBlock:I(r)?r:a}),c&&n.push({node:c,parentBlock:I(h)?h:a})):c?e.push({node:c,parentBlock:I(h)?h:a}):n.length>0&&e.push(n.pop())}return i}(t),r=s.map(function(t){var e=function(t){for(var e=[],n="",i=0;i<t.length;i++){var o=t[i];e.push({textNode:o,text:o.nodeValue,range:{start:n.length,end:n.length+o.nodeValue.length}}),n="".concat(n).concat(o.nodeValue)}return{text:n,ranges:e}}(t),s=e.text,r=e.ranges,a=new RegExp(i,n),l=new Map,c=new T,h=a.exec(s);if(!h)return null;for(;h&&h[0];){for(var d=h.index,u=S(h,1)[0],f=d+u.length,p="string"==typeof o?o:"",m="string"==typeof o?u:"",v="",y=0;y<r.length;y++){var g=r[y],b=g.textNode,_=g.text,k=g.range,w=k.start,E=k.end;if(!(w>f||E<d)){var x=new B(_,u);if(x.range={start:Math.max(w,d)-w,end:Math.min(E,f)-w},"string"==typeof o){var L=x.range;v=p.slice(0,L.end-L.start),p=p.slice(L.end-L.start),!(m=m.slice(L.end-L.start))&&p.length>0&&(v="".concat(v).concat(p),p=""),x.replaceFunction=function(t){return function(){return document.createTextNode(t)}}(v)}else x.replaceFunction=o;var C=l.get(b);C||(C=new N(b),c.add(C),l.set(b,C)),C.addReplacement(x)}}h=a.exec(s)}l.clear();for(var I=c.head;I;)I.replace(),I=I.next;return function(){for(var t=null==c?void 0:c.head;t;)t.recover(),t=t.next;c=null}});return function(){return r.forEach(function(t){null==t||t()})}}function O(){return window.SimsapaFindState||(window.SimsapaFindState=new Map),window.SimsapaFindState}const F=new class{constructor(){this.searchTerm="",this.currentMatchIndex=0,this.totalMatches=0,this.isVisible=!1,this.recoverFunction=null,this.debounceTimer=null,this.searchButton=null,this.findBar=null,this.findInput=null,this.findCounter=null,this.findError=null,this.prevButton=null,this.nextButton=null,this.accentFoldCheckbox=null,this.caseSensitiveCheckbox=null,this.contentArea=null,this.initializeElements()}initializeElements(){"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>this.bindElements()):this.bindElements()}bindElements(){this.searchButton=document.getElementById("findSearchButton"),this.findBar=document.getElementById("findBar"),this.findInput=document.getElementById("findInput"),this.findCounter=document.getElementById("findCounter"),this.findError=document.getElementById("findError"),this.prevButton=document.getElementById("findPrevButton"),this.nextButton=document.getElementById("findNextButton"),this.accentFoldCheckbox=document.getElementById("findAccentFold"),this.caseSensitiveCheckbox=document.getElementById("findCaseSensitive"),this.contentArea=document.getElementById("ssp_content"),this.setupEventListeners(),this.loadPreferences()}setupEventListeners(){this.searchButton&&this.searchButton.addEventListener("click",()=>this.toggle()),this.findInput&&(this.findInput.addEventListener("input",t=>{const e=t.target;this.debouncedSearch(e.value)}),this.findInput.addEventListener("keydown",t=>this.handleInputKeydown(t))),this.nextButton&&this.nextButton.addEventListener("click",()=>this.nextMatch()),this.prevButton&&this.prevButton.addEventListener("click",()=>this.previousMatch()),this.accentFoldCheckbox&&this.accentFoldCheckbox.addEventListener("change",()=>{this.searchTerm&&this.search(this.searchTerm),this.savePreferences()}),this.caseSensitiveCheckbox&&this.caseSensitiveCheckbox.addEventListener("change",()=>{this.searchTerm&&this.search(this.searchTerm),this.savePreferences()}),document.addEventListener("keydown",t=>this.handleGlobalKeydown(t))}handleInputKeydown(t){"Enter"===t.key?t.shiftKey?(t.preventDefault(),this.previousMatch()):(t.preventDefault(),this.nextMatch()):"Escape"===t.key&&(t.preventDefault(),this.hide())}handleGlobalKeydown(t){return t.ctrlKey&&"f"===t.key?(t.preventDefault(),void this.show()):"Escape"===t.key&&this.isVisible?(t.preventDefault(),void this.hide()):void 0}loadPreferences(){const t=O(),e=t.get("simsapa-find-term");e&&this.findInput&&(this.findInput.value=e);const n=t.get("simsapa-find-accent-fold");this.accentFoldCheckbox&&(this.accentFoldCheckbox.checked=!1!==n);const i=t.get("simsapa-find-case-sensitive");this.caseSensitiveCheckbox&&(this.caseSensitiveCheckbox.checked=!0===i)}savePreferences(){const t=O();this.findInput&&t.set("simsapa-find-term",this.findInput.value),this.accentFoldCheckbox&&t.set("simsapa-find-accent-fold",this.accentFoldCheckbox.checked),this.caseSensitiveCheckbox&&t.set("simsapa-find-case-sensitive",this.caseSensitiveCheckbox.checked)}debouncedSearch(t){null!==this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{this.search(t),this.savePreferences()},400)}show(){this.findBar&&this.searchButton&&(this.isVisible=!0,this.searchButton.classList.add("active"),this.findBar.classList.add("show"),setTimeout(()=>{this.findInput&&(this.findInput.focus(),this.findInput.select(),this.findInput.value&&this.findInput.value.length>=2&&this.search(this.findInput.value))},100))}hide(){this.findBar&&this.searchButton&&(this.isVisible=!1,this.searchButton.classList.remove("active"),this.findBar.classList.remove("show"),this.clearHighlights(),this.clearError())}clearHighlights(){this.recoverFunction&&(this.recoverFunction(),this.recoverFunction=null),this.updateCounter(0,0)}clearError(){this.findError&&(this.findError.classList.remove("show"),this.findError.textContent="")}updateCounter(t,e){this.findCounter&&(this.findCounter.textContent=`${t}/${e}`),this.currentMatchIndex=t,this.totalMatches=e}search(t){if(this.clearHighlights(),this.clearError(),t&&!(t.length<2)&&this.contentArea){this.searchTerm=t;try{this.recoverFunction=this.performSearch(t),this.updateMatchNavigation()}catch(t){this.showError("Invalid search pattern")}}}performSearch(t){if(!this.contentArea)return null;let e="g";this.isCaseSensitive()||(e+="i");const n=this.isAccentFoldingEnabled()?this.createAccentFoldedPattern(t):t,i=(s=this.contentArea,r={find:n,flag:e,replace:(t,e)=>{const n=document.createElement("span");return n.className="ssp-find-highlight",n.textContent=t,n}},a=Object.assign({},{flag:"g"},r),"string"==typeof s?function(t,e){var n=document.createElement("div");return n.innerHTML=t,$(n,e),n.innerHTML}(s,a):L(s)?$(s,a):null),o=this.contentArea.querySelectorAll(".ssp-find-highlight");var s,r,a;return this.updateCounter(o.length>0?1:0,o.length),0===o.length?(this.showError("No matches found"),i):(o.length>1e3&&this.showError(`Too many matches (${o.length}). Results limited to improve performance.`),o[0].classList.add("current"),this.scrollToElement(o[0]),i)}createAccentFoldedPattern(t){if(!this.isAccentFoldingEnabled())return t;const e=["ā","ī","ū","ṃ","ṁ","ṅ","ñ","ṭ","ḍ","ṇ","ḷ","ṛ","ṣ","ś"],n=["a","i","u","m","m","n","n","t","d","n","l","r","s","s"],i=new Map;for(let t=0;t<e.length;t++){const o=n[t],s=e[t];i.has(o)||i.set(o,new Set([o])),i.get(o).add(s)}const o=new Map;for(const[t,e]of i){const n=`[${Array.from(e).join("")}]`;o.set(t,n);for(const i of e)i!==t&&o.set(i,n)}let s="";for(const e of t)s+=o.get(e)||e;return s}isAccentFoldingEnabled(){return!this.accentFoldCheckbox||this.accentFoldCheckbox.checked}isCaseSensitive(){return!!this.caseSensitiveCheckbox&&this.caseSensitiveCheckbox.checked}updateMatchNavigation(){if(!this.prevButton||!this.nextButton)return;const t=this.totalMatches>0;this.prevButton.style.opacity=t?"1":"0.5",this.nextButton.style.opacity=t?"1":"0.5"}scrollToElement(t){t.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})}showError(t){this.findError&&(this.findError.textContent=t,this.findError.classList.add("show"))}nextMatch(){if(!this.contentArea||0===this.totalMatches)return;const t=this.contentArea.querySelectorAll(".ssp-find-highlight");if(0===t.length)return;t.forEach(t=>t.classList.remove("current"));let e=this.currentMatchIndex%this.totalMatches;t[e].classList.add("current"),this.updateCounter(e+1,this.totalMatches),this.scrollToElement(t[e])}previousMatch(){if(!this.contentArea||0===this.totalMatches)return;const t=this.contentArea.querySelectorAll(".ssp-find-highlight");if(0===t.length)return;t.forEach(t=>t.classList.remove("current"));let e=this.currentMatchIndex-2;e<0&&(e=this.totalMatches-1),t[e].classList.add("current"),this.updateCounter(e+1,this.totalMatches),this.scrollToElement(t[e])}toggle(){this.isVisible?this.hide():this.show()}isShown(){return this.isVisible}setSearchTerm(t){this.findInput&&(this.findInput.value=t,this.show(),t&&t.length>=2&&(this.search(t),this.savePreferences()))}};function A(t){t.querySelectorAll("a").forEach(t=>{u(t)&&t.classList.add("sutta-link"),t.addEventListener("click",f)})}function D(){const t=document.getElementById("ssp_content");if(t)A(t);else{const t=document.body;t&&A(t)}}document.SSP={show_transient_message:function(t,e){const n=document.createElement("div");n.className="message";const i=document.createElement("div");i.className="msg-content",i.textContent=t,n.appendChild(i);let o=document.getElementById(e);o?(o.appendChild(n),n.style.transition="opacity 1.5s ease-in-out",n.style.opacity="1",setTimeout(()=>{n.style.opacity="0"},1e3),n.addEventListener("transitionend",()=>{n.remove()})):console.error("Cannot find: transient-messages")},find:F,attach_link_handlers:D},document.addEventListener("DOMContentLoaded",()=>{D()})})();