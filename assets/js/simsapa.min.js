(()=>{"use strict";var t={d:(e,n)=>{for(var o in n)t.o(n,o)&&!t.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:n[o]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};t.d({},{_:()=>z});var e=function(t,e,n,o){return new(n||(n=Promise))(function(i,s){function r(t){try{l(o.next(t))}catch(t){s(t)}}function a(t){try{l(o.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(r,a)}l((o=o.apply(t,e||[])).next())})};const n=new class{constructor(){this.overlay=null,this.message_element=null,this.confirm_button=null,this.cancel_button=null,this.copy_button=null,this.current_url="",this.resolve_callback=null,this.initialized=!1,this.handlers_bound=!1}init(){const t=document.getElementById("confirmModalOverlay"),e=document.getElementById("confirmModalMessage"),n=document.getElementById("confirmModalConfirm"),o=document.getElementById("confirmModalCancel"),i=document.getElementById("confirmModalCopy");if(!(t&&e&&n&&o&&i))return console.error("[ConfirmModal] Required elements not found in DOM"),void(this.initialized=!1);this.overlay===t&&this.confirm_button===n&&this.cancel_button===o&&this.copy_button===i&&this.initialized||(this.overlay=t,this.message_element=e,this.confirm_button=n,this.cancel_button=o,this.copy_button=i,this.confirm_button.addEventListener("click",()=>this.handle_confirm()),this.cancel_button.addEventListener("click",()=>this.handle_cancel()),this.copy_button.addEventListener("click",()=>this.handle_copy()),this.overlay.addEventListener("click",t=>this.handle_overlay_click(t)),this.handlers_bound||(document.addEventListener("keydown",t=>this.handle_keydown(t)),this.handlers_bound=!0),this.initialized=!0)}show(t,e){return this.init(),this.overlay&&this.message_element?(this.current_url=e,this.message_element.textContent=t,this.overlay.classList.add("show"),new Promise(t=>{this.resolve_callback=e=>{t(e.confirmed)}})):(console.error("[ConfirmModal] Modal not initialized"),Promise.resolve(!1))}handle_confirm(){this.close(!0)}handle_cancel(){this.close(!1)}handle_copy(){return e(this,void 0,void 0,function*(){if(this.current_url)try{const t=globalThis.API_URL||"http://localhost:4848",e=yield fetch(`${t}/copy_to_clipboard`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:this.current_url})});e.ok?this.show_copy_feedback(!0):(console.error("[ConfirmModal] Copy failed with status:",e.status),this.show_copy_feedback(!1))}catch(t){console.error("[ConfirmModal] Failed to copy URL:",t),this.show_copy_feedback(!1)}else console.error("[ConfirmModal] No URL to copy")})}show_copy_feedback(t){if(!this.copy_button)return;const e=this.copy_button.textContent;this.copy_button.textContent=t?"Copied!":"Copy Failed",this.copy_button.classList.add(t?"success":"error"),setTimeout(()=>{this.copy_button&&(this.copy_button.textContent=e,this.copy_button.classList.remove("success","error"))},2e3)}handle_overlay_click(t){t.target===this.overlay&&this.close(!1)}handle_keydown(t){var e;"Escape"===t.key&&(null===(e=this.overlay)||void 0===e?void 0:e.classList.contains("show"))&&this.close(!1)}close(t){this.overlay&&(this.overlay.classList.remove("show"),this.resolve_callback&&(this.resolve_callback({confirmed:t}),this.resolve_callback=null))}};function o(t){return e(this,void 0,void 0,function*(){const e=`Open this link in your web browser?\n\n${t}`;return n.show(e,t)})}const i=new class{constructor(){this.overlay=null,this.title_element=null,this.body_element=null,this.close_button=null,this.initialized=!1,this.handlers_bound=!1}init(){const t=document.getElementById("footnoteModalOverlay"),e=document.getElementById("footnoteModalTitle"),n=document.getElementById("footnoteModalBody"),o=document.getElementById("footnoteModalClose");if(!(t&&e&&n&&o))return console.error("[FootnoteModal] Required elements not found in DOM"),void(this.initialized=!1);this.overlay===t&&this.close_button===o&&this.initialized||(this.overlay=t,this.title_element=e,this.body_element=n,this.close_button=o,this.close_button.addEventListener("click",()=>this.close()),this.overlay.addEventListener("click",t=>this.handle_overlay_click(t)),this.handlers_bound||(document.addEventListener("keydown",t=>this.handle_keydown(t)),this.handlers_bound=!0),this.initialized=!0)}show(t,e){this.init(),this.overlay&&this.title_element&&this.body_element?(this.title_element.textContent=`Note ${t}`,this.body_element.innerHTML=e,z(this.body_element),this.overlay.classList.add("show")):console.error("[FootnoteModal] Modal not initialized")}handle_overlay_click(t){t.target===this.overlay&&this.close()}handle_keydown(t){var e;"Escape"===t.key&&(null===(e=this.overlay)||void 0===e?void 0:e.classList.contains("show"))&&this.close()}close(){this.overlay&&this.overlay.classList.remove("show")}is_visible(){var t;return(null===(t=this.overlay)||void 0===t?void 0:t.classList.contains("show"))||!1}};function s(t){return t.replace(/[\[\]]/g,"").trim()}function r(t){const e=document.getElementById(t);if(!e)return null;const n=e.cloneNode(!0);if(n.querySelectorAll('a[href^="#fr-"]').forEach(t=>t.remove()),"LI"===n.tagName)return n.innerHTML;if(n.classList.contains("footnote-definition")){const t=n.querySelector(".footnote-definition-label");return t&&t.remove(),n.innerHTML}if("P"===n.tagName){let t=n.innerHTML;return t=t.replace(/^\d+\.\s*/,""),t}return n.innerHTML}function a(t){const e=t.getAttribute("href")||"";if(!e.startsWith("#"))return null;if(!t.closest(".footnote-reference, .fn"))return null;const n=e.substring(1);return document.getElementById(n)?n:null}const l=new class{constructor(){this.overlay=null,this.title_element=null,this.body_element=null,this.close_button=null,this.initialized=!1,this.handlers_bound=!1}init(){const t=document.getElementById("invalidLinkModalOverlay"),e=document.getElementById("invalidLinkModalTitle"),n=document.getElementById("invalidLinkModalBody"),o=document.getElementById("invalidLinkModalClose");if(!(t&&e&&n&&o))return console.error("[InvalidLinkModal] Required elements not found in DOM"),void(this.initialized=!1);this.overlay===t&&this.close_button===o&&this.initialized||(this.overlay=t,this.title_element=e,this.body_element=n,this.close_button=o,this.close_button.addEventListener("click",()=>this.close()),this.overlay.addEventListener("click",t=>this.handle_overlay_click(t)),this.handlers_bound||(document.addEventListener("keydown",t=>this.handle_keydown(t)),this.handlers_bound=!0),this.initialized=!0)}show(t){this.init(),this.overlay&&this.title_element&&this.body_element?(this.title_element.textContent="Invalid Link",this.body_element.innerHTML=`Invalid link target: <code>${t}</code>`,z(this.body_element),this.overlay.classList.add("show")):console.error("[InvalidLinkModal] Modal not initialized")}handle_overlay_click(t){t.target===this.overlay&&this.close()}handle_keydown(t){var e;"Escape"===t.key&&(null===(e=this.overlay)||void 0===e?void 0:e.classList.contains("show"))&&this.close()}close(){this.overlay&&this.overlay.classList.remove("show")}is_visible(){var t;return(null===(t=this.overlay)||void 0===t?void 0:t.classList.contains("show"))||!1}};var c=function(t,e,n,o){return new(n||(n=Promise))(function(i,s){function r(t){try{l(o.next(t))}catch(t){s(t)}}function a(t){try{l(o.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(r,a)}l((o=o.apply(t,e||[])).next())})};const h=/\b(DN|MN|SN|AN|Pv|Vv|Vism|iti|kp|khp|snp|th|thag|thig|ud|uda|dhp)[ .]*(\d[\d.:]*)\b/i;function d(t,e){return c(this,void 0,void 0,function*(){const n=globalThis.API_URL||"http://localhost:4848",o=yield fetch(`${n}/logger`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({log_level:e,msg:t})});if(!o.ok)throw new Error(`HTTP error! status: ${o.status} ${o.statusText}`)})}function u(t){return c(this,void 0,void 0,function*(){console.log(t),d(t,"info")})}function f(t){return c(this,void 0,void 0,function*(){console.error(t),d(t,"error")})}function m(t){return c(this,void 0,void 0,function*(){const e=globalThis.API_URL||"http://localhost:4848";try{const n=yield fetch(`${e}/open_external_url`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:t})});n.ok||f(`Failed to open external URL: ${n.status}`)}catch(t){f(`Error opening external URL: ${t instanceof Error?t.message:String(t)}`)}})}function v(t){const e=t.getAttribute("href")||"",n=t.textContent||"";if(e.startsWith("ssp://")){const t=e.match(/^ssp:\/\/suttas\/(.+)$/);if(t)return t[1]}if(e.includes("suttacentral.net")){const t=e.match(/suttacentral\.net\/(.+)$/);if(t)return t[1]}if(e.includes("thebuddhaswords.net")){const t=e.match(/\/suttas\/([^.]+)\.html/);if(t)return`${t[1]}/pli/ms`}const o=n.replace(/:/g,".").match(h);return o?`${o[1].toLowerCase()}${o[2]}/pli/ms`:null}function p(t){return c(this,void 0,void 0,function*(){const e=t.target;let n=null;if(n="A"===e.tagName?e:e.closest("a"),!n)return;const h=n.getAttribute("href")||"";if(h.startsWith("#"))return function(t){const e=a(t);if(!e)return!1;const n=r(e);if(!n)return console.error("[FootnoteModal] Could not find footnote content for:",e),!1;const o=s(t.textContent||"");return i.show(o,n),!0}(n)?void t.preventDefault():void 0;const d=v(n);if(d)return t.preventDefault(),void(yield function(t,e){return c(this,void 0,void 0,function*(){const n=window,s=n.API_URL||globalThis.API_URL||"http://localhost:4848",r=n.WINDOW_ID||globalThis.WINDOW_ID;if(!r||""===r)return yield f(`WINDOW_ID not defined, falling back to open_sutta_by_uid for uid='${t}'`),void(yield function(t,e){return c(this,void 0,void 0,function*(){const n=globalThis.API_URL||"http://localhost:4848";try{const s=`${n}/open_sutta_window/${t}`,r=yield fetch(s);if(404===r.status){f(`Sutta not found: ${t}`);let n=`Sutta not found in database: ${t}`;e?(n+=`\n\nOriginal URL: ${e}\n\nWould you like to open this link in your web browser?`,i.is_visible()&&i.close(),(yield o(e))&&window.open(e,"_blank")):alert(n)}else r.ok?u(`Successfully opened sutta ${t}`):f(`Failed to open sutta ${t}: ${r.status}`)}catch(e){const n=e instanceof Error?e.message:String(e);f(`Error opening sutta ${t}: ${n}`)}})}(t,e));yield u(`open_sutta_in_tab: WINDOW_ID='${r}', uid='${t}'`);try{const n=`${s}/open_sutta_tab/${r}/${t}`,a=yield fetch(n);if(404===a.status){f(`Sutta not found: ${t}`);let n=`Sutta not found in database: ${t}`;e?(n+=`\n\nOriginal URL: ${e}\n\nWould you like to open this link in your web browser?`,i.is_visible()&&i.close(),(yield o(e))&&(yield m(e))):alert(n)}else a.ok||f(`Failed to open sutta ${t}: ${a.status}`)}catch(e){const n=e instanceof Error?e.message:String(e);f(`Error opening sutta ${t}: ${n}`)}})}(d,h));if(h.startsWith("/book_pages/")){const e=window.location.pathname,n=h.split("#")[0];return n!==e.split("#")[0]&&""!==n?(t.preventDefault(),void(yield function(t){return c(this,void 0,void 0,function*(){const e=window,n=e.API_URL||globalThis.API_URL||"http://localhost:4848",o=e.WINDOW_ID||globalThis.WINDOW_ID;if(!o||""===o)return yield u(`WINDOW_ID not defined, navigating to book page: ${t}`),void(window.location.href=t);yield u(`open_book_page_in_tab: WINDOW_ID='${o}', url='${t}'`);try{const e=`${n}/open_book_page_tab/${o}`,i=yield fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({book_page_url:t})});i.ok||(yield f(`Failed to open book page ${t}: ${i.status}`))}catch(e){const n=e instanceof Error?e.message:String(e);yield f(`Error opening book page ${t}: ${n}`)}})}(h))):void 0}return h.startsWith("http://")||h.startsWith("https://")?(t.preventDefault(),i.is_visible()&&i.close(),void((yield o(h))&&(yield m(h)))):h.startsWith("/")?(t.preventDefault(),i.is_visible()&&i.close(),void l.show(h)):void 0})}var y=function(){return y=Object.assign||function(t){for(var e,n=1,o=arguments.length;n<o;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t},y.apply(this,arguments)};function b(t){return Object.freeze(t.reduce(function(t,e){var n;return Object.assign(t,((n={})[e.toLocaleLowerCase()]=!0,n))},{}))}b(["base","head","link","meta","style","title"]);var g=b(["address","article","aside","footer","header","h1","h2","h3","h4","h5","h6","hgroup","main","nav","section"]),_=b(["blockquote","dd","dir","div","dl","dt","figcaption","figure","hr","li","main","ol","p","pre","ul"]),w=b(["a","abbr","b","bdi","bdo","br","cite","code","data","dfn","em","i","kbd","mark","q","rb","rt","rtc","ruby","s","samp","small","span","strong","sub","sup","time","tt","u","var","wbr"]),k=b(["area","audio","img","map","track","video"]),E=b(["applet","embed","iframe","noembed","object","param","picture","source"]),L=(b(["canvas","noscript","script"]),b(["del","ins"]),b(["caption","col","colgroup","table","tbody","td","tfoot","th","thead","tr"])),x=b(["button","datalist","fieldset","form","input","label","legend","meter","optgroup","option","output","progress","select","textarea"]),I=(b(["details","dialog","menu","menuitem","summary"]),b(["acronym","applet","basefont","bgsound","big","blink","center","command","content","dir","element","font","frame","frameset","image","isindex","keygen","listing","marquee","menuitem","multicol","nextid","nobr","noembed","noframes","plaintext","shadow","spacer","strike","tt","xmp"]),b(["br","img","col","hr"])),C=y(y(y(y(y(y(y({},g),_),k),E),L),x),I);function B(t){return!!t&&t.nodeType===Node.ELEMENT_NODE}function M(t){return!!t&&t.nodeType===Node.TEXT_NODE}function S(t){return B(t)&&!!C[t.tagName.toLocaleLowerCase()]}function T(t){return B(t)&&(function(t){return B(t)&&!!I[t.tagName.toLocaleLowerCase()]}(t)||-1!==["SVG"].indexOf(t.tagName.toUpperCase()))}y(y({},w),{br:void 0,code:void 0});var N=function(){function t(t,e){this.foundText=e||"",this.text=t,this.range={start:0,end:0},this.replaceFunction=function(t){return document.createTextNode(t)}}return t.prototype.replace=function(){var t=this.range,e=t.start,n=t.end;if(e===n)return null;var o=this.text.slice(e,n);return this.replaceFunction(o,this.foundText)},t}(),$=function(){function t(t){this.next=null,this.replacements=[],this.replacedNodes=[],this.textNode=t}return t.prototype.addReplacement=function(t){if(0===this.replacements.length){if(t.range.start>0){var e=new N(this.textNode.nodeValue);e.range={start:0,end:t.range.start},this.replacements.push(e)}}else{var n=this.replacements[this.replacements.length-1];if(t.range.start-n.range.end>0){var o=new N(this.textNode.nodeValue);o.range={start:n.range.end,end:t.range.start},this.replacements.push(o)}else if(t.range.start-n.range.end<0)throw"Can't add replacement if replacement.range.start is less than last added replacement.range.end"}this.replacements.push(t)},t.prototype.replace=function(){var t=this.replacements[this.replacements.length-1],e=[];if(t.range.end<this.textNode.nodeValue.length){var n=new N(this.textNode.nodeValue);n.range={start:t.range.end,end:this.textNode.nodeValue.length},e.push(n)}var o=this.replacements.concat(e).reduce(function(t,e){var n=e.replace();return n?(t.push(n),t):t},[]);this.replacedNodes=o,this.textNode.parentNode&&this.textNode.parentNode.replaceChild(o.reduce(function(t,e){return t.appendChild(e),t},document.createDocumentFragment()),this.textNode)},t.prototype.recover=function(){for(var t=!1,e=0;e<this.replacedNodes.length;e++){var n=this.replacedNodes[e];try{var o=n.parentNode;if(!o)continue;t?o.removeChild(n):(o.replaceChild(this.textNode,n),t=!0)}catch(t){console.error("You might have changed dom node so that we can't recover")}}},t}(),O=function(){function t(){this.head=null,this.tail=null}return t.prototype.add=function(t){this.head?this.head!==t&&this.tail&&(this.tail.next=t,this.tail=t):this.head=this.tail=t},t}(),P=function(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var o,i,s=n.call(t),r=[];try{for(;(void 0===e||e-- >0)&&!(o=s.next()).done;)r.push(o.value)}catch(t){i={error:t}}finally{try{o&&!o.done&&(n=s.return)&&n.call(s)}finally{if(i)throw i.error}}return r};function D(t,e){var n=e.flag,o=e.find,i=e.replace,s=function(t){var e=[],n=[],o=[];if(!t.firstChild||!S(t))return o;e.push({node:t.firstChild,parentBlock:t});var i=t;for(o.push([]);e.length>0;){var s=e.pop(),r=s.node,a=s.parentBlock,l=r.firstChild,c=r.nextSibling,h=r.parentNode;i!==a&&0!==o[o.length-1].length&&o.push([]),i=a,M(r)?o[o.length-1].push(r):T(r)&&0!==o[o.length-1].length&&o.push([]),l?(e.push({node:l,parentBlock:S(r)?r:a}),c&&n.push({node:c,parentBlock:S(h)?h:a})):c?e.push({node:c,parentBlock:S(h)?h:a}):n.length>0&&e.push(n.pop())}return o}(t),r=s.map(function(t){var e=function(t){for(var e=[],n="",o=0;o<t.length;o++){var i=t[o];e.push({textNode:i,text:i.nodeValue,range:{start:n.length,end:n.length+i.nodeValue.length}}),n="".concat(n).concat(i.nodeValue)}return{text:n,ranges:e}}(t),s=e.text,r=e.ranges,a=new RegExp(o,n),l=new Map,c=new O,h=a.exec(s);if(!h)return null;for(;h&&h[0];){for(var d=h.index,u=P(h,1)[0],f=d+u.length,m="string"==typeof i?i:"",v="string"==typeof i?u:"",p="",y=0;y<r.length;y++){var b=r[y],g=b.textNode,_=b.text,w=b.range,k=w.start,E=w.end;if(!(k>f||E<d)){var L=new N(_,u);if(L.range={start:Math.max(k,d)-k,end:Math.min(E,f)-k},"string"==typeof i){var x=L.range;p=m.slice(0,x.end-x.start),m=m.slice(x.end-x.start),!(v=v.slice(x.end-x.start))&&m.length>0&&(p="".concat(p).concat(m),m=""),L.replaceFunction=function(t){return function(){return document.createTextNode(t)}}(p)}else L.replaceFunction=i;var I=l.get(g);I||(I=new $(g),c.add(I),l.set(g,I)),I.addReplacement(L)}}h=a.exec(s)}l.clear();for(var C=c.head;C;)C.replace(),C=C.next;return function(){for(var t=null==c?void 0:c.head;t;)t.recover(),t=t.next;c=null}});return function(){return r.forEach(function(t){null==t||t()})}}function F(){return window.SimsapaFindState||(window.SimsapaFindState=new Map),window.SimsapaFindState}const A=new class{constructor(){this.searchTerm="",this.currentMatchIndex=0,this.totalMatches=0,this.isVisible=!1,this.recoverFunction=null,this.debounceTimer=null,this.searchButton=null,this.findBar=null,this.findInput=null,this.findCounter=null,this.findError=null,this.prevButton=null,this.nextButton=null,this.accentFoldCheckbox=null,this.caseSensitiveCheckbox=null,this.contentArea=null,this.initializeElements()}initializeElements(){"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>this.bindElements()):this.bindElements()}bindElements(){this.searchButton=document.getElementById("findSearchButton"),this.findBar=document.getElementById("findBar"),this.findInput=document.getElementById("findInput"),this.findCounter=document.getElementById("findCounter"),this.findError=document.getElementById("findError"),this.prevButton=document.getElementById("findPrevButton"),this.nextButton=document.getElementById("findNextButton"),this.accentFoldCheckbox=document.getElementById("findAccentFold"),this.caseSensitiveCheckbox=document.getElementById("findCaseSensitive"),this.contentArea=document.getElementById("ssp_content"),this.setupEventListeners(),this.loadPreferences()}setupEventListeners(){this.searchButton&&this.searchButton.addEventListener("click",()=>this.toggle()),this.findInput&&(this.findInput.addEventListener("input",t=>{const e=t.target;this.debouncedSearch(e.value)}),this.findInput.addEventListener("keydown",t=>this.handleInputKeydown(t))),this.nextButton&&this.nextButton.addEventListener("click",()=>this.nextMatch()),this.prevButton&&this.prevButton.addEventListener("click",()=>this.previousMatch()),this.accentFoldCheckbox&&this.accentFoldCheckbox.addEventListener("change",()=>{this.searchTerm&&this.search(this.searchTerm),this.savePreferences()}),this.caseSensitiveCheckbox&&this.caseSensitiveCheckbox.addEventListener("change",()=>{this.searchTerm&&this.search(this.searchTerm),this.savePreferences()}),document.addEventListener("keydown",t=>this.handleGlobalKeydown(t))}handleInputKeydown(t){"Enter"===t.key?t.shiftKey?(t.preventDefault(),this.previousMatch()):(t.preventDefault(),this.nextMatch()):"Escape"===t.key&&(t.preventDefault(),this.hide())}handleGlobalKeydown(t){return t.ctrlKey&&"f"===t.key?(t.preventDefault(),void this.show()):"Escape"===t.key&&this.isVisible?(t.preventDefault(),void this.hide()):void 0}loadPreferences(){const t=F(),e=t.get("simsapa-find-term");e&&this.findInput&&(this.findInput.value=e);const n=t.get("simsapa-find-accent-fold");this.accentFoldCheckbox&&(this.accentFoldCheckbox.checked=!1!==n);const o=t.get("simsapa-find-case-sensitive");this.caseSensitiveCheckbox&&(this.caseSensitiveCheckbox.checked=!0===o)}savePreferences(){const t=F();this.findInput&&t.set("simsapa-find-term",this.findInput.value),this.accentFoldCheckbox&&t.set("simsapa-find-accent-fold",this.accentFoldCheckbox.checked),this.caseSensitiveCheckbox&&t.set("simsapa-find-case-sensitive",this.caseSensitiveCheckbox.checked)}debouncedSearch(t){null!==this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{this.search(t),this.savePreferences()},400)}show(){this.findBar&&this.searchButton&&(this.isVisible=!0,this.searchButton.classList.add("active"),this.findBar.classList.add("show"),setTimeout(()=>{this.findInput&&(this.findInput.focus(),this.findInput.select(),this.findInput.value&&this.findInput.value.length>=2&&this.search(this.findInput.value))},100))}hide(){this.findBar&&this.searchButton&&(this.isVisible=!1,this.searchButton.classList.remove("active"),this.findBar.classList.remove("show"),this.clearHighlights(),this.clearError())}clearHighlights(){this.recoverFunction&&(this.recoverFunction(),this.recoverFunction=null),this.updateCounter(0,0)}clearError(){this.findError&&(this.findError.classList.remove("show"),this.findError.textContent="")}updateCounter(t,e){this.findCounter&&(this.findCounter.textContent=`${t}/${e}`),this.currentMatchIndex=t,this.totalMatches=e}search(t){if(this.clearHighlights(),this.clearError(),t&&!(t.length<2)&&this.contentArea){this.searchTerm=t;try{this.recoverFunction=this.performSearch(t),this.updateMatchNavigation()}catch(t){this.showError("Invalid search pattern")}}}performSearch(t){if(!this.contentArea)return null;let e="g";this.isCaseSensitive()||(e+="i");const n=this.isAccentFoldingEnabled()?this.createAccentFoldedPattern(t):t,o=(s=this.contentArea,r={find:n,flag:e,replace:(t,e)=>{const n=document.createElement("span");return n.className="ssp-find-highlight",n.textContent=t,n}},a=Object.assign({},{flag:"g"},r),"string"==typeof s?function(t,e){var n=document.createElement("div");return n.innerHTML=t,D(n,e),n.innerHTML}(s,a):B(s)?D(s,a):null),i=this.contentArea.querySelectorAll(".ssp-find-highlight");var s,r,a;return this.updateCounter(i.length>0?1:0,i.length),0===i.length?(this.showError("No matches found"),o):(i.length>1e3&&this.showError(`Too many matches (${i.length}). Results limited to improve performance.`),i[0].classList.add("current"),this.scrollToElement(i[0]),o)}createAccentFoldedPattern(t){if(!this.isAccentFoldingEnabled())return t;const e=["ā","ī","ū","ṃ","ṁ","ṅ","ñ","ṭ","ḍ","ṇ","ḷ","ṛ","ṣ","ś"],n=["a","i","u","m","m","n","n","t","d","n","l","r","s","s"],o=new Map;for(let t=0;t<e.length;t++){const i=n[t],s=e[t];o.has(i)||o.set(i,new Set([i])),o.get(i).add(s)}const i=new Map;for(const[t,e]of o){const n=`[${Array.from(e).join("")}]`;i.set(t,n);for(const o of e)o!==t&&i.set(o,n)}let s="";for(const e of t)s+=i.get(e)||e;return s}isAccentFoldingEnabled(){return!this.accentFoldCheckbox||this.accentFoldCheckbox.checked}isCaseSensitive(){return!!this.caseSensitiveCheckbox&&this.caseSensitiveCheckbox.checked}updateMatchNavigation(){if(!this.prevButton||!this.nextButton)return;const t=this.totalMatches>0;this.prevButton.style.opacity=t?"1":"0.5",this.nextButton.style.opacity=t?"1":"0.5"}scrollToElement(t){t.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})}showError(t){this.findError&&(this.findError.textContent=t,this.findError.classList.add("show"))}nextMatch(){if(!this.contentArea||0===this.totalMatches)return;const t=this.contentArea.querySelectorAll(".ssp-find-highlight");if(0===t.length)return;t.forEach(t=>t.classList.remove("current"));let e=this.currentMatchIndex%this.totalMatches;t[e].classList.add("current"),this.updateCounter(e+1,this.totalMatches),this.scrollToElement(t[e])}previousMatch(){if(!this.contentArea||0===this.totalMatches)return;const t=this.contentArea.querySelectorAll(".ssp-find-highlight");if(0===t.length)return;t.forEach(t=>t.classList.remove("current"));let e=this.currentMatchIndex-2;e<0&&(e=this.totalMatches-1),t[e].classList.add("current"),this.updateCounter(e+1,this.totalMatches),this.scrollToElement(t[e])}toggle(){this.isVisible?this.hide():this.show()}isShown(){return this.isVisible}setSearchTerm(t){this.findInput&&(this.findInput.value=t,this.show(),t&&t.length>=2&&(this.search(t),this.savePreferences()))}},W=new class{constructor(){this.container=null,this.observer=null,this.visible_footnotes=new Map,this.initialized=!1}init(){this.initialized||(this.container=document.getElementById("footnoteBottomBar"),this.container?(this.setup_observer(),this.observe_all_footnotes(),this.initialized=!0):console.error("[FootnoteBottomBar] Container element not found in DOM"))}setup_observer(){this.observer=new IntersectionObserver(t=>{t.forEach(t=>{const e=t.target,n=a(e);n&&(t.isIntersecting?this.add_visible_footnote(e,n):this.remove_visible_footnote(n))})},{root:null,rootMargin:"0px",threshold:.5})}observe_all_footnotes(){this.observer&&document.querySelectorAll('.footnote-reference a[href^="#"], .fn a[href^="#"]').forEach(t=>{const e=t;a(e)&&this.observer.observe(e)})}add_visible_footnote(t,e){if(this.visible_footnotes.has(e))return;const n=r(e);if(!n)return;const o=s(t.textContent||"");this.visible_footnotes.set(e,{number:o,content:n,id:e}),this.update_display()}remove_visible_footnote(t){this.visible_footnotes.delete(t),this.update_display()}update_display(){var t;if(!this.container)return;if(!1===(null===(t=document.SSP)||void 0===t?void 0:t.show_bottom_footnotes)||0===this.visible_footnotes.size)return this.container.classList.remove("show"),void document.body.classList.remove("footnote-bar-visible");const e=Array.from(this.visible_footnotes.values()).sort((t,e)=>{const n=parseInt(t.number,10),o=parseInt(e.number,10);return isNaN(n)||isNaN(o)?t.number.localeCompare(e.number):n-o});let n="";e.forEach(t=>{n+=`\n                <div class="footnote-item" data-footnote-id="${t.id}">\n                    <span class="footnote-number">[${t.number}]</span>\n                    <div class="footnote-content">${t.content}</div>\n                </div>\n            `}),this.container.innerHTML=n,z(this.container),this.container.classList.add("show"),document.body.classList.add("footnote-bar-visible")}destroy(){this.observer&&(this.observer.disconnect(),this.observer=null),this.visible_footnotes.clear(),this.container&&this.container.classList.remove("show"),document.body.classList.remove("footnote-bar-visible"),this.initialized=!1}refresh(){this.destroy(),this.init()}};function z(t){t.querySelectorAll("a").forEach(t=>{v(t)&&t.classList.add("sutta-link"),t.addEventListener("click",p)})}function R(){const t=document.getElementById("ssp_content");if(t)z(t);else{const t=document.body;t&&z(t)}}const H={scrollSmallUp:function(){window.scrollBy({top:-80,behavior:"smooth"})},scrollSmallDown:function(){window.scrollBy({top:80,behavior:"smooth"})},scrollHalfPageUp:function(){const t=window.innerHeight/2;window.scrollBy({top:-t,behavior:"smooth"})},scrollHalfPageDown:function(){const t=window.innerHeight/2;window.scrollBy({top:t,behavior:"smooth"})},scrollPageUp:function(){const t=window.innerHeight-50;window.scrollBy({top:-t,behavior:"smooth"})},scrollPageDown:function(){const t=window.innerHeight-50;window.scrollBy({top:t,behavior:"smooth"})},scrollToTop:function(){window.scrollTo({top:0,behavior:"smooth"})},scrollToBottom:function(){window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"})}};document.SSP={show_transient_message:function(t,e){const n=document.createElement("div");n.className="message";const o=document.createElement("div");o.className="msg-content",o.textContent=t,n.appendChild(o);let i=document.getElementById(e);i?(i.appendChild(n),n.style.transition="opacity 1.5s ease-in-out",n.style.opacity="1",setTimeout(()=>{n.style.opacity="0"},1e3),n.addEventListener("transitionend",()=>{n.remove()})):console.error("Cannot find: transient-messages")},find:A,attach_link_handlers:R,show_bottom_footnotes:!0,scroll:H},window.footnote_bottom_bar_refresh=function(){document.SSP.show_bottom_footnotes?W.refresh():W.destroy()},document.addEventListener("DOMContentLoaded",()=>{R(),document.getElementById("ssp_content")&&document.SSP.show_bottom_footnotes&&W.init()})})();